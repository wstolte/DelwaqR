{
    "contents" : "#######################################################################\n####                                                               ####\n####          Script by willem.stolte@deltares.nl                  ####\n####    Reads MWTL csv and  makes season and long term graphs      ####\n####                                                               ####\n####                copyright Deltares                             ####\n####                                                               ####\n#######################################################################\n\nrequire(scales)\nrequire(plyr)\nrequire(reshape2)\nrequire(ggplot2)\n\nsubmap <- read.csv2(\"d:/Tools_Scripts/Mapping tables/RWS2DELWAQ2names.csv\", header = T, stringsAsFactors=FALSE)\nlocmap <- read.csv2(\"d:/Tools_Scripts/Mapping tables/RWS2DELWAQ2locations.csv\", header = T, stringsAsFactors=FALSE)\nlocmod = c(\"Huibertgat_oost\", \"IMARES_st_2\", \"IMARES_st_3b\", \"Bocht_van_Watum\", \"IMARES_st_4b\", \"IMARES_st_5\", \"Groote_Gat_noord\")\n\nrws_dat           <- read.csv2(\"d:\\\\GIS-DATA\\\\Nederland\\\\EemsDoll\\\\naarPostGis\\\\RWS\\\\MWTL_all.csv\",dec = \".\")\nrws_dat$datetime   <- as.POSIXct(rws_dat$datetime, format = \"%d-%m-%y %H:%M\")\nrws_dat$variable   <- mapvalues(as.character(rws_dat$parhdhcod), from = submap$RWS_DONAR_parcod_hdh2, to = submap$Delwaq_long_name, warn_missing = F)\n# rws_dat$location   <- mapvalues(as.character(rws_dat$locoms), from = locmap$locoms, to = locmap$Delwaq_ED, warn_missing = F)\n# rws_dat$variable   <- mapvalues(as.character(rws_dat$variable), from = submap$Delwaq, to = submap$Delwaq_long_name, warn_missing = F)\nrws_dat$month      <- format(rws_dat$datetime, format = \"%m\")\n#filter for high PO4 and NH4 measurements\nrws_dat <- subset(rws_dat, rws_dat$wrd < 0.6 | rws_dat$variable != \"phosphate\")\nrws_dat <- subset(rws_dat, rws_dat$wrd < 1 | rws_dat$variable != \"P nf\")\nrws_dat <- subset(rws_dat, rws_dat$wrd < 1 | rws_dat$variable != \"TotP\")\nrws_dat <- subset(rws_dat, rws_dat$wrd < 0.6 | rws_dat$variable != \"ammonium\")\nrws_dat <- subset(rws_dat, rws_dat$wrd < 75 | rws_dat$variable != \"chlorophyll-a\")\nrws_dat <- subset(rws_dat, rws_dat$wrd < 3 | rws_dat$variable != \"N pg\")\nrws_dat <- subset(rws_dat, rws_dat$wrd < 30 | rws_dat$variable != \"dissolved org C\")\nrws_dat <- subset(rws_dat, rws_dat$wrd < 1e11 )\nrws_dat <- subset(rws_dat, rws_dat$wrd >= 0 )\n\nsave(rws_dat, file = \"d:/Tools_Scripts/R/ShinyMeetEems/MWTL_Eems_bewerkt.Rdata\")\n\n#==================================================================================\n\nload(\"d:/Tools_Scripts/R/ShinyMeetEems/MWTL_Eems_bewerkt.Rdata\")\n## linear regression taking into account seasonal variation as sin/cos\n## per station:\n\nsubstance <- \"chlorophyll-a\"\nlocation  <- \"Groote Gat noord\"\nsubdf = subset(rws_dat, rws_dat$variable == substance &\n  rws_dat$locoms == location &\n  rws_dat$wrd < 500)\nx = as.numeric(subdf$datetime); y = subdf$wrd\nregression <- summary(glm(y ~ x + I(cos(2 * pi * x / 31622400)) + I(sin(2 * pi * x / 31622400))))\nslope <- regression$coefficients[[2]]  #slope of regression including season effect\nintercept <- regression$coefficients[[1]]\nregression\nprint(paste(\"slope is: \", slope*31622400, \"per year\"))\n\npl <- ggplot(subdf, aes(datetime, wrd))\npl <- pl + facet_grid(variable ~ locoms, scales = \"free\") #+ scale_x_datetime(limits = c(as.POSIXct(\"2004-01-01\"), as.POSIXct(\"2013-12-31\")))\npl <- pl + geom_point()\n# pl <- pl + geom_smooth(aes(group = 1) , method=\"lm\")\npl <- pl + geom_smooth(aes(), method='lm', formula = y ~ x+I(cos(2*pi*x/31622400))+I(sin(2*pi*x/31622400)), size = 0.5, alpha = 0.5)\npl <- pl + geom_abline(intercept = intercept, slope = slope , color = \"darkblue\", size = 1)\npl <- pl + theme(text = element_text(size = 16))\npl <- pl + xlab(\"date\") + ylab(substance) #+ scale_y_continuous(limits = c(0,0.2))\nprint(pl)\n\n## 5 - Make box plots of long term monthly values and compare to 2012 ==========================\n\nq <- ggplot(subdf,aes(month,wrd))\nq + geom_boxplot(outlier.colour = \"orange\", alpha = 0.5, color = \"orange\", notch = TRUE, notchwidth = 0.5) +\n  facet_grid(variable ~ locoms, scales = \"free\") +\n  xlab(\"month\") + ylab(\"mg N /l\")\n\n\nsubstance <- c(\"TotN\", \"TotP\")\nsubstance <- c(\"nitrate\", \"phosphate\")\nlocation  <- c(\"Groote Gat noord\", \"Bocht van Watum\", \"Huibertgat oost\")\nsubdf = subset(rws_dat, rws_dat$variable %in% substance &\n                 rws_dat$locoms %in% location &\n                 rws_dat$wrd < 500)\nsubdf$locoms <- factor(subdf$locoms, levels = rev(location))\n\nx = as.numeric(subdf$datetime); y = subdf$wrd\nregression <- summary(glm(y ~ x + I(cos(2 * pi * x / 31622400)) + I(sin(2 * pi * x / 31622400))))\nslope <- regression$coefficients[[2]]  #slope of regression including season effect\nintercept <- regression$coefficients[[1]]\nregression\nprint(paste(\"slope is: \", slope*31622400, \"per year\"))\n\nsubdf$year <- ifelse(subdf$month == 12,\n                     format(subdf$datetime + 31622400, \"%Y\"),\n                     format(subdf$datetime, \"%Y\"))\n\nsubdf.winter <- subdf[subdf$month %in% c(\"12\",\"01\",\"02\"),]\nsummary.winter <- ddply(subdf.winter, .(variable, locoms, year),\n                        summarize, mean = mean(wrd))\nsubdf.summer <- subdf[subdf$month %in% c(\"07\",\"08\",\"09\"),]\n\n\npl <- ggplot(subdf, aes(datetime, wrd))\npl <- pl + facet_grid(variable ~ locoms, scales = \"free\") #+ scale_x_datetime(limits = c(as.POSIXct(\"2004-01-01\"), as.POSIXct(\"2013-12-31\")))\npl <- pl + geom_point()\n# pl <- pl + geom_smooth(aes(group = 1) , method=\"lm\")\npl <- pl + geom_smooth(aes(), method='lm', formula = y ~ x+I(cos(2*pi*x/31622400))+I(sin(2*pi*x/31622400)), size = 0.5, alpha = 0.5)\n# pl <- pl + geom_abline(intercept = intercept, slope = slope , color = \"darkblue\", size = 1)\npl <- pl + theme(text = element_text(size = 16))\npl <- pl + geom_smooth(aes(as.POSIXct(year), wrd), data = subdf.winter)\npl <- pl + xlab(\"date\") + ylab(substance) #+ scale_y_continuous(limits = c(0,0.2))\nprint(pl)\n\nq <- ggplot(subdf,aes(month,wrd))\nq +\n#   geom_boxplot(outlier.colour = \"orange\", alpha = 0.5, color = \"orange\", notch = TRUE, notchwidth = 0.5) +\n  geom_smooth(aes(group = 1),\n              method='lm',\n              formula = y ~ x+I(cos(2*pi*x/12))+I(sin(2*pi*x/12)),\n              size = 2, alpha = 0) +\n  geom_jitter(color = \"darkolivegreen\", alpha = 0.3) +\n  facet_grid(variable ~ locoms, scales = \"free\") +\n  theme(text = element_text(size = 16)) +\n  xlab(\"month\") + ylab(\"mg N or P /l\")\n\n\n\npl2 <- ggplot(summary.winter, aes(year, mean))\npl2 + geom_point() + geom_smooth(aes(group = 1), method = \"lm\") +\n  facet_grid(variable ~ locoms, scales = \"free\")\n",
    "created" : 1425282967159.000,
    "dirty" : true,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2992113864",
    "id" : "445A1933",
    "lastKnownWriteTime" : 1425976161,
    "path" : "D:/Tools_Scripts/R/MWTL/MWTL-analyse-klankbordgroep.R",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}